# ONT ID规范

> 版本：1.3.5
>
> This version is based on [`ONT ID 0.7.0`](./archived/ontid-0.7.0.md). Brief update is referenced [`here`](./archived/ontid-update-1.3.5.md).

ONT ID是本体提供的一套身份标识系统，具有去中心化、自主管理、隐私保护、安全易用等特点。

## 生成ONT ID

ONT ID是一种URI，由每个实体自己生成成，生成算法需要保证碰撞概率非常低。同时在向本体注册时，共识节点会检查该ID是否已被注册。

一个合法的ONT ID生成过程如下：

1. 生成32字节的随机nonce，计算h = Hash160(nonce），data = VER || h；
2. 计算出data的一个4字节校验，即checksum = SHA256(SHA256(data))[0:4]；
3. 令idString = base58(data || checksum)；
4. 将"did:ont:"与idString拼接，即ID = "did:ont:" || idString；
5. 输出ID。

上述过程中，|| 表示连接前后两个字节串，VER 是1个字节的标签位。


## 管理权

ONT ID有两种管理方式：自主管理和代理控制

### 自主管理

自主管理即ONT ID的所有者自己控制ID，进行注册、修改和注销等操作。在注册到链上时，ONT ID需要绑定所有者的公钥，而所有者自己持有对应的私钥。

一个ONT ID可以绑定多个公钥。各公钥按照绑定顺序依次从1开始编号。绑定数量的上限为2^32-1。绑定的公钥可以被废除。已废除的公钥不可被再次启用，且仍占有一个编号。

当使用ID时，所有者使用私钥进行签名，并给出对应公钥的编号。验证端根据编号查找到公钥，验证签名。

### 代理控制

一个ONT ID可以被其他ONT ID代理控制。这种情况下被控制的ONT ID可以不绑定公钥。控制者拥有被控制ID的注册、修改和注销权限，但不能操作恢复人。在操作时被控制ID时，控制者需提供有效的数字签名。

控制者可以是一个ONT ID，也可以是若干ONT ID组成的管理组。管理组能够设置复杂的门限控制逻辑，以满足不同的安全需求。如设置n个ONT ID，最少m个ID共同签名才能进行操作(m <= n)，以如下JSON形式表示：

```json
{
  "threshold": m,
  "members": [ID1, ID2, ... , IDn]
}
```

进一步的，可以定义递归组合的控制逻辑，即组成员可以是ONT ID，也可以是嵌套的管理组，如下所示：


```json
{
  "threshold": m1,
  "members": [
    ID1,
    {
      "threshold": m2,
      "members": [ID2, ...]
    },
    ...
  ]
}
```

控制者的ONT ID必须是自主管理的。

控制者可以为被控制的ID绑定公钥，将其转换为自主管理模式。但是自主管理的ID无法转换成代理控制的模式。

## 恢复人

自主管理的ONT ID允许所有者设置其他ONT ID为恢复人。在所有者意外丢失密钥的情况下，恢复人可以帮助其重置密钥。

恢复人使用组管理的方式，规则同代理控制的管理组相同。

恢复人能够为ID添加、废除公钥，以及更新恢复人设置。操作时需提供符合控制逻辑的有效的数字签名。

## 附加属性

ONT ID的所有者或代理控制者可以为其添加、修改或删除附加属性。属性以健值对的方式保存。属性的具体内容不在本规范的范畴内，由应用层自行定义。


## 注销ONT ID

ONT ID的所有者或代理控制人可以将其注销。执行注销操作后，该ONT ID关联的密钥、控制人、属性及恢复人等一切数据将被删除，仅保留ID本身。已注销的ONT ID无法继续使用，也不能再次注册启用。


## 合约实现

ONT ID的管理功能由一个native合约实现。合约地址是0x0000000000000000000000000000000000000003。

### 接口

#### 数据结构

* 管理组：

```
Group {
    threshold    //门限，整数
    members      //成员数组
}
```

其中成员数组中的每个成员是一个字节串，根据前8个字节是否为"did:ont:"判断是一个ONT ID或一个嵌套的Group结构体。若是ONT ID，则必须是已注册的自主管理的ONT ID。

* 签名人：

```
Signer {
    id     //签名人ONT ID
    index  //验签公钥编号
}
```


* 属性：

```
Attribute {
    key      //属性的键，字节串
    type     //属性的类型，字节串
    value    //属性的值，字节串
}
```


#### 注册自主管理的ONT ID

regIDWithPublicKey

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  字节串  | 所有者的公钥

调用此接口需提供参数中的公钥对应私钥的签名。注册完成后此公钥即与ONT ID绑定。

触发事件：("Register", ONT ID)


#### 注册代理控制的ONT ID

regIDWithController

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  字节串  | 代理控制人
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

参数1的字节串即可以是一个ONT ID，也可以是一个序列化的管理组结构体，根据前8个字节加以区分。

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件：("Register", ONT ID)


#### 废弃自主管理的ONT ID

revokeID

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  整数    | 所有者的验签公钥编号

触发事件：("Revoke", ONT ID)


#### 废弃代理控制的ONT ID

revokeIDByController

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

触发事件：("Revoke", ONT ID)


#### 撤销代理控制人

removeController

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数    | 所有者的验签公钥编号

调用此接口需提供所有者的签名，并通过参数1指明验签公钥的编号。

触发事件：("RemoveController", ONT ID)


#### 设置恢复人

addRecovery

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 恢复人，为序列化的管理人数组
 2  |  整数    | 验签公钥

调用此接口需提供所有者的签名，并通过参数2指明验签公钥的编号。

触发事件：("Recovery", "add", ONT ID, JSON形式表示的恢复人)


#### 更新恢复人

changeRecovery

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 新恢复人，为序列化的管理人数组
 2  |  字节串  | 签名人列表，为序列化的签名人数组

调用此接口需提供原恢复人的有效签名。

触发事件：("Recovery", "change", ONT ID, JSON形式表示的新恢复人)


#### 所有者添加公钥

addKey

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 添加的新公钥
 2  |  字节串  | 验签公钥

调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("PublicKey", "add", ONT ID, 新公钥, 新公钥编号)


#### 所有者废除公钥

removeKey

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 废除的公钥
 2  |  字节串  | 验签公钥

调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("PublicKey", "remove", ONT ID, 废除的公钥, 废除公钥的编号)

#### 代理控制人添加公钥

addKeyByController

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 添加的新公钥
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件： ("PublicKey", "add by controller", ONT ID, 新公钥, 新公钥编号)


#### 恢复人添加公钥

addKeyByRecovery

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 添加的新公钥
 2  |  字节串  | 序列化的签名人数组

调用此接口需提供恢复人的有效签名。

触发事件：("PublicKey", "add by recovery", ONT ID, 新公钥, 新公钥编号)


#### 恢复人废除公钥

removeKeyByRecovery

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数    | 废除公钥的编号
 2  |  字节串  | 序列化的签名人数组

调用此接口需提供恢复人的有效签名。

触发事件：("PublicKey", "remove by recovery", ONT ID, 废除的公钥, 废除公钥的编号)


#### 注册ONT ID同时添加属性

regIDWithAttributes

编号 |  类型      | 说明
----|------------|-------
 0  |  字节串     | ONT ID
 1  |  字节串     | 所有者的公钥
 2  |  属性结构体数组 | 属性数组

调用此接口需提供所有者的签名，并通过参数1给出所有者公钥。注册完成后公钥与该ID绑定，且参数2给出的属性被添加到该ID中。

触发事件：("Register", ONT ID)


#### 所有者添加属性

addAttributes

参数:

编号 |  类型      | 说明
----|------------|-------
 0  |  字节串     | ONT ID
 1  |  属性结构体数组 | 属性数组
 2  |  字节串     | 验签公钥


调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("Attribute", "add", ONT ID, 添加的属性键列表)


#### 所有者删除属性

removeAttribute

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 删除属性的键
 2  |  字节串  | 验签公钥

调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("Attribute", "remove", ONT ID, 删除属性的键)


#### 代理控制人添加属性

addAttributesByController

参数:

编号 |  类型      | 说明
----|------------|-------
 0  |  字节串     | ONT ID
 1  |  属性结构体数组  | 属性数组
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件：("Attribute", "add by controller", ONT ID, 添加的属性键列表)


#### 代理控制人删除属性

removeAttributeByController

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 删除属性的键
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件：("Attribute", "remove by controller", ONT ID, 删除属性的键)


#### 验证签名

VerifySignature

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数    | 公钥编号

接口调用的交易需包含被验证的签名，且通过参数1指明验证公钥的编号。

返回：True/False

#### 验证控制人签名

VerifyController

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数/签名人结构体数组  | 签名公钥编号/签名人列表


若控制人是一个ONT ID，则参数1数组中仅包含其一个元素；若是一个管理组，则需要列出所有参与的签名人。

调用接口的交易需包含所有被验证的签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

返回：True/False

### 存储

所有数据均存储在此合约空间内，即存储的键添加合约地址作为前缀。方便起见，以下列出的存储键均省略前缀。

符号说明：

* `+` 表示连接前后字节串
* `ID` 表示ONT ID


存储内容 |   键      |   值        | 备注
--------|----------|-------------|-----
注册标记 |  `ID`     | `0x01`      | 作为ONT ID的存在标记
公钥     | `ID+0x01` | 公钥列表     | 记录ONT ID绑定的公钥，包括已废弃的公钥
属性     | `ID+0x02` | 属性列表     | 以链表形式存储ONT ID的属性，便于删除操作
恢复人   | `ID+0x03` | 管理组结构体  | 存储的结构体与接口传入的相同
控制人   | `ID+0x04` | ONT ID或管理组结构体 |
版本号   | `0x00`    |  `0x01`     | 标示当前存储版本，用于非兼容处理，目前取值为1
